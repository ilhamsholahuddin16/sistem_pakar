{% extends "base.html" %}

{% block title %}Diagnosis - Sistem Pakar Penyakit Lambung{% endblock %}

{% block extra_css %}
<style>
    .gejala-item {
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 15px 20px;
        margin-bottom: 12px;
        background: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .gejala-item:hover {
        background-color: #f8f9fa;
        border-color: #3498db;
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
    }

    .gejala-item.selected {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-color: #2196F3;
        border-width: 2px;
    }

    .gejala-item.selected .gejala-code {
        color: #1976D2;
        font-weight: bold;
    }

    .gejala-code {
        background: #f5f5f5;
        padding: 5px 12px;
        border-radius: 8px;
        font-weight: bold;
        color: #666;
        min-width: 60px;
        text-align: center;
        font-size: 0.85rem;
    }

    .gejala-item.selected .gejala-code {
        background: #1976D2;
        color: white;
    }

    .gejala-text {
        flex: 1;
        margin: 0 15px;
        font-size: 0.95rem;
    }

    .gejala-checkbox {
        width: 24px;
        height: 24px;
        cursor: pointer;
    }

    .selected-panel {
        position: sticky;
        top: 20px;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
    }

    .selected-item {
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        color: white;
        padding: 12px 15px;
        border-radius: 10px;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .btn-remove {
        background: rgba(255,255,255,0.3);
        border: none;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-remove:hover {
        background: rgba(255,255,255,0.5);
        transform: scale(1.1);
    }

    .search-box {
        border-radius: 25px;
        border: 2px solid #e0e0e0;
        padding: 12px 24px;
        font-size: 1rem;
    }

    .search-box:focus {
        border-color: #3498db;
        box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
    }

    .category-badge {
        display: inline-block;
        padding: 6px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        margin: 5px;
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid transparent;
    }

    .category-badge:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .category-all { background: #6c757d; color: white; }
    .category-nyeri { background: #e74c3c; color: white; }
    .category-pencernaan { background: #f39c12; color: white; }
    .category-lain { background: #3498db; color: white; }

    .empty-state {
        text-align: center;
        padding: 30px;
        color: #999;
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 10px;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-main">
    <div class="text-center mb-4">
        <h2 class="fw-bold">
            <i class="fas fa-stethoscope text-primary"></i>
            Diagnosis Penyakit Lambung
        </h2>
        <p class="text-muted">Pilih gejala yang Anda alami dengan mudah</p>
    </div>

    <form id="diagnosisForm" method="POST" action="{{ url_for('process_diagnosis') }}">
        <div class="row">
            <!-- Left Panel - Daftar Gejala -->
            <div class="col-lg-8">
                <!-- User Name Input -->
                <div class="card mb-4">
                    <div class="card-body">
                        <label for="nama_user" class="form-label fw-bold">
                            <i class="fas fa-user"></i> Nama Anda
                        </label>
                        <input type="text" class="form-control form-control-lg" id="nama_user" name="nama_user"
                               placeholder="Masukkan nama Anda untuk tracking riwayat" required>
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            Nama digunakan untuk menyimpan dan melacak riwayat konsultasi Anda
                        </small>
                    </div>
                </div>

                <!-- Search Box -->
                <div class="mb-3">
                    <input type="text" class="form-control search-box" id="searchGejala"
                           placeholder="ðŸ” Cari gejala yang Anda alami...">
                </div>

                <!-- Category Filter -->
                <div class="mb-4 text-center">
                    <span class="category-badge category-all active" data-category="all">
                        <i class="fas fa-th"></i> Semua Gejala
                    </span>
                    <span class="category-badge category-nyeri" data-category="nyeri">
                        <i class="fas fa-heartbeat"></i> Nyeri & Perih
                    </span>
                    <span class="category-badge category-pencernaan" data-category="pencernaan">
                        <i class="fas fa-stomach"></i> Pencernaan
                    </span>
                    <span class="category-badge category-lain" data-category="lain">
                        <i class="fas fa-plus"></i> Lainnya
                    </span>
                </div>

                <!-- Gejala List -->
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-list-ul"></i> Pilih Gejala yang Anda Alami
                    </div>
                    <div class="card-body p-3" id="gejalaList">
                        {% if gejala_list %}
                            {% for gejala in gejala_list %}
                            <div class="gejala-item"
                                 data-id="{{ gejala.id }}"
                                 data-kode="{{ gejala.kode_gejala }}"
                                 data-nama="{{ gejala.nama_gejala }}"
                                 data-search="{{ gejala.nama_gejala|lower }}"
                                 data-category="{% if 'nyeri' in gejala.nama_gejala|lower or 'perih' in gejala.nama_gejala|lower or 'sakit' in gejala.nama_gejala|lower %}nyeri{% elif 'mual' in gejala.nama_gejala|lower or 'muntah' in gejala.nama_gejala|lower or 'kembung' in gejala.nama_gejala|lower or 'sendawa' in gejala.nama_gejala|lower or 'diare' in gejala.nama_gejala|lower or 'bab' in gejala.nama_gejala|lower %}pencernaan{% else %}lain{% endif %}">
                                <span class="gejala-code">{{ gejala.kode_gejala }}</span>
                                <span class="gejala-text">{{ gejala.nama_gejala }}</span>
                                <input type="checkbox" class="gejala-checkbox" value="{{ gejala.id }}">
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                Data gejala belum tersedia. Silakan jalankan setup_database.py terlebih dahulu.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Right Panel - Gejala Terpilih -->
            <div class="col-lg-4">
                <div class="selected-panel">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <i class="fas fa-check-circle"></i> Gejala Terpilih
                            <span class="badge bg-light text-success float-end" id="selectedCount">0</span>
                        </div>
                        <div class="card-body" id="selectedList">
                            <div class="empty-state">
                                <i class="fas fa-hand-pointer"></i>
                                <p>Belum ada gejala yang dipilih</p>
                                <small>Klik gejala di sebelah kiri untuk memilih</small>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button type="button" class="btn btn-outline-danger btn-sm w-100" id="clearAllBtn" style="display:none;">
                                <i class="fas fa-trash"></i> Hapus Semua Pilihan
                            </button>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="card mt-3">
                        <div class="card-body text-center">
                            <button type="submit" class="btn btn-primary btn-lg w-100" id="submitBtn" disabled>
                                <i class="fas fa-search"></i> Proses Diagnosis
                            </button>
                            <small class="text-muted d-block mt-2">
                                Minimal pilih 1 gejala
                            </small>
                        </div>
                    </div>

                    <!-- Info -->
                    <div class="alert alert-info mt-3">
                        <small>
                            <i class="fas fa-lightbulb"></i>
                            <strong>Tips:</strong> Pilih semua gejala yang Anda rasakan untuk hasil diagnosis yang lebih akurat.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5>Memproses Diagnosis...</h5>
                    <p class="text-muted mb-0">Sistem sedang menganalisis gejala menggunakan Forward Chaining</p>
                    <div class="progress mt-3" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                             style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">
                            Analyzing...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
var selectedGejala = [];

$(document).ready(function() {
    // Function to update display
    function updateDisplay() {
        const count = selectedGejala.length;
        $('#selectedCount').text(count);
        $('#submitBtn').prop('disabled', count === 0);
        $('#clearAllBtn').toggle(count > 0);

        // Update selected list
        if (count === 0) {
            $('#selectedList').html(`
                <div class="empty-state">
                    <i class="fas fa-hand-pointer"></i>
                    <p>Belum ada gejala yang dipilih</p>
                    <small>Klik gejala di sebelah kiri untuk memilih</small>
                </div>
            `);
        } else {
            let html = '';
            selectedGejala.forEach(function(gejala) {
                html += `
                    <div class="selected-item" data-id="${gejala.id}">
                        <div>
                            <strong>${gejala.kode}</strong><br>
                            <small>${gejala.nama}</small>
                        </div>
                        <button type="button" class="btn-remove" onclick="removeGejala(${gejala.id})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            });
            $('#selectedList').html(html);
        }

        // Update visual state of items
        $('.gejala-item').each(function() {
            const id = parseInt($(this).data('id'));
            const isSelected = selectedGejala.some(g => g.id === id);
            $(this).toggleClass('selected', isSelected);
            $(this).find('.gejala-checkbox').prop('checked', isSelected);
        });
    }

    // Click on gejala item
    $('.gejala-item').on('click', function(e) {
        if ($(e.target).hasClass('gejala-checkbox')) return; // Handled by checkbox change

        const id = parseInt($(this).data('id'));
        const kode = $(this).data('kode');
        const nama = $(this).data('nama');

        const index = selectedGejala.findIndex(g => g.id === id);
        if (index > -1) {
            selectedGejala.splice(index, 1);
        } else {
            selectedGejala.push({ id, kode, nama });
        }
        updateDisplay();
    });

    // Checkbox change
    $('.gejala-checkbox').on('change', function(e) {
        e.stopPropagation();
        const item = $(this).closest('.gejala-item');
        const id = parseInt(item.data('id'));
        const kode = item.data('kode');
        const nama = item.data('nama');

        const index = selectedGejala.findIndex(g => g.id === id);
        if (this.checked && index === -1) {
            selectedGejala.push({ id, kode, nama });
        } else if (!this.checked && index > -1) {
            selectedGejala.splice(index, 1);
        }
        updateDisplay();
    });

    // Clear all button
    $('#clearAllBtn').on('click', function() {
        if (confirm('Hapus semua gejala yang dipilih?')) {
            selectedGejala = [];
            updateDisplay();
        }
    });

    // Search functionality
    $('#searchGejala').on('keyup', function() {
        const searchText = $(this).val().toLowerCase();
        $('.gejala-item').each(function() {
            const gejalaText = $(this).data('search');
            const matchSearch = searchText === '' || gejalaText.includes(searchText);
            $(this).toggle(matchSearch);
        });
    });

    // Category filter
    $('.category-badge').on('click', function() {
        $('.category-badge').removeClass('active');
        $(this).addClass('active');

        const category = $(this).data('category');
        $('.gejala-item').each(function() {
            if (category === 'all') {
                $(this).show();
            } else {
                $(this).toggle($(this).data('category') === category);
            }
        });
    });

    // Form submission
    $('#diagnosisForm').on('submit', function(e) {
        e.preventDefault();

        if (selectedGejala.length === 0) {
            alert('âš ï¸ Silakan pilih minimal 1 gejala!');
            return;
        }

        const namaUser = $('#nama_user').val().trim();
        if (!namaUser) {
            alert('âš ï¸ Silakan masukkan nama Anda!');
            $('#nama_user').focus();
            return;
        }

        // Show loading modal
        const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
        loadingModal.show();

        // Prepare form data
        const formData = new FormData();
        formData.append('nama_user', namaUser);
        selectedGejala.forEach(function(gejala) {
            formData.append('gejala[]', gejala.id);
        });

        // Submit via AJAX
        $.ajax({
            url: $(this).attr('action'),
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                loadingModal.hide();
                if (response.success) {
                    window.location.href = '/hasil-diagnosis/' + response.riwayat_id;
                } else {
                    alert('âŒ Error: ' + response.message);
                }
            },
            error: function(xhr) {
                loadingModal.hide();
                const response = xhr.responseJSON;
                alert('âŒ Error: ' + (response ? response.message : 'Terjadi kesalahan sistem. Pastikan database sudah disetup.'));
            }
        });
    });

    // Initial update
    updateDisplay();

    // Expose updateDisplay to global scope
    window.updateDisplay = updateDisplay;
});

// Global function to remove gejala (called from button)
function removeGejala(id) {
    const index = selectedGejala.findIndex(g => g.id === id);
    if (index > -1) {
        selectedGejala.splice(index, 1);
        window.updateDisplay();
    }
}
</script>
{% endblock %}
